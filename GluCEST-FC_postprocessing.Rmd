---
title: "GluCEST-FC_postprocessing"
output: html_document
  rmdformats::robobook:
    highlight: monochrome
    lightbox: true
    gallery: true
date: "2024-02-20"
---

# Load packages 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(ggplot2)

#source("/cbica/projects/thalamocortical_development/software/rotate_parcellation/R/perm.sphere.p.R") This package is used for parcel-based spin testing.

#https://www.middleprofessor.com/files/applied-biostatistics_bookdown/_book/adding-covariates-to-a-linear-model
```

# Set up Environment
```{r, message=F, warning=F}
setwd("~/GluCESTfMRI/glucest-rsfmri")

```

# Set Variables
```{r, message=F, warning=F}
# Set fieldstrength and read in group data:
fieldstrength= "3T"
grp_df <- read_grp_data(fieldstrength,'grp_df_') 
diag_df = read_grp_data(fieldstrength,'diag_df_')
```

# Choose what to analyse
```{r, message=F, warning=F}
networks = c( "Vis", "SalVentAttn", "SomMot") #"Cont", "Default", "DorsAttn",, "Limbic"
CESTnetworks = c("avgCEST_SomMot", "avgCEST_DorsAttn",  "avgCEST_Vis" ) # "avgCEST_Cont", "ctCEST_Cont", "avgCEST_Default", "ctCEST_Default",,"avgCEST_Limbic", "ctCEST_Limbic",  "avgCEST_SalVentAttn","ctCEST_SalVentAttn"
CESTcts = c("ctCEST_SomMot", "ctCEST_DorsAttn","ctCEST_Vis")

CNB_scores = c("tap_tot")
CNB_valids = c("tap_valid") #, 
diag_scores = c("dx_pscat") # ,"axis1_desc1","axis1_stat1"
demo_scores = c("sex", "age", "race","ethnic","dateDiff")
diag_details = c("axis1_desc1", "axis1_desc2", "axis1_desc3","axis1_desc4","axis1_desc5", "axis1_desc6")

covariate_age = 'age' 
covariate_sex = 'sex'
covariate_ct = 'count'

grp_df$'age' <- as.numeric(grp_df$'age')

```

## QC Analyses
```{r, message=F, warning=F}
# Histograms
vars = c(CESTnetworks, CNB_scores, covariate_age)
for (var in vars) {
  print(var)
  hist(grp_df[[var]],
       main=paste("Histogram of", var,sep=" "),
       xlab=paste(var))
}
```

## QC Demographic variables
```{r, message=F, warning=F}
# Bar graph comparing M and F SomMot and FC.
```

## Linear Models 
```{r, message=F, warning=F}
# linear model of GluCEST vs tapping corrected for age

# SomMot GluCEST vs Tapping Score
m1 <- lm(tap_tot ~ avgCEST_SomMot + age + sex, data = grp_df)
gg <- ggplot(grp_df, 
             aes(x = avgCEST_SomMot,
                 y = tap_tot)) + #, color=hstatus
  geom_point() + #aes(color=treatment)
  geom_smooth(method = "lm",
              mapping = aes(y = predict(m1, grp_df))) +
  ylab("Tapping Score") +
  xlab("SomMot GluCEST") +
 # theme_pander() +
  theme(legend.position="bottom") 
gg

# Vis GluCEST vs Tapping Score
m1 <- lm(tap_tot ~ avgCEST_Vis + age + sex, data = grp_df)
gg <- ggplot(grp_df, 
             aes(x = avgCEST_Vis,
                 y = tap_tot)) + #, color=hstatus
  geom_point() + #aes(color=treatment)
  geom_smooth(method = "lm",
              mapping = aes(y = predict(m1, grp_df))) +
  ylab("Tapping Score") +
  xlab("Vis GluCEST") +
 # theme_pander() +
  theme(legend.position="bottom") 
gg

```

## Linear Models Broken Loop
``{r, message=F, warning=F}
# Fix this loop. Trying to loop through networks to plot. 
CESTnetworks = c(avgCEST_SomMot, avgCEST_DorsAttn,  avgCEST_Vis) 
for (CESTnetwork in CESTnetworks) {
  graph_df = grp_df
  graph_df %>% drop_na(CESTnetwork, 'tap_tot', 'age')
  m1 <- lm(tap_tot ~ avgCEST_SomMot + age, data = graph_df) # 'sex',
  gg <- ggplot(graph_df, 
             aes(x = CESTnetwork,
                 y = 'tap_tot')) + 
    geom_point() + #aes(color=treatment)
    geom_smooth(method = "lm",
              mapping = aes(y = predict(m1, graph_df))) +
  ylab("Area of necrosis (mg)") +
  xlab("Area at risk (mg)") +
 # theme_pander() +
  theme(legend.position="bottom") 
  
  print(gg)
}
``

## Multiple regression
```{r, message=F, warning=F}
# Make a bar graph with all avg CEST values for each network
# Run t test comparing all networks.


```

## Compare Network CEST
```{r, message=F, warning=F}
# Make a bar graph with all avg CEST values for each network
# Run t test comparing all networks' CEST
# Run t test comparing network CEST in healthy vs control subjs

```


